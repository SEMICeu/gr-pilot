<?vsp
-- /search handler script
--
-- Copyright 2014 European Union
-- Author: Vianney le ClÃ©ment de Saint-Marcq (PwC EU Services)
--
-- Licensed under the EUPL, Version 1.1 or - as soon they
-- will be approved by the European Commission - subsequent
-- versions of the EUPL (the "Licence");
-- You may not use this work except in compliance with the
-- Licence.
-- You may obtain a copy of the Licence at:
-- http://ec.europa.eu/idabc/eupl
--
-- Unless required by applicable law or agreed to in
-- writing, software distributed under the Licence is
-- distributed on an "AS IS" basis,
-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
-- express or implied.
-- See the Licence for the specific language governing
-- permissions and limitations under the Licence.

-- The current_charset in VSPs seems to always be ISO-8859-1. Hence, all
-- parameters are interpreted as such. By setting http_charset, we avoid
-- recoding them. This preserves the UTF-8 meaning of the values when passed
-- further on in, e.g., http_proxy.
set http_charset=current_charset();

declare _q, _limit varchar;
_q := get_keyword('q', params, '');
_limit := atoi(get_keyword('limit', params, '0'));

declare filter, limit, query, url varchar;
if(_q <> '') {
  _q := replace(_q, '\\', '\\\\');
  _q := replace(_q, '"', '\\"');
  _q := replace(_q, '\n', '\\n');
  _q := replace(_q, '\r', '\\r');
  filter := sprintf('FILTER(CONTAINS(LCASE(STR(?Name)), LCASE("%s")))', _q);
} else {
  filter := '';
}
if(_limit > 0) {
  limit := sprintf('LIMIT %d', _limit);
} else {
  limit := '';
}
query := sprintf('SELECT DISTINCT ?VAT ?Name WHERE {
                    ?VAT a org:Organization ;
                    rdfs:label ?Name .
                    %s
                  } %s', filter, limit);
url := sprintf('/sparql?query=%U&format=%U&xslt-uri=%U',
               query,
               'application/sparql-results+xml',
               '%ROOTURI%xslt/sparql-table.xsl');

http_proxy('localhost', vector(sprintf('GET %s HTTP/1.0', url)), null);
?>
